<?xml version="1.0" encoding="UTF-8"?>
<!--
    Intentioned MSI Installer
    
    To build this MSI:
    1. Install WiX Toolset v3.11+ from https://wixtoolset.org/
    2. Run: candle installer.wxs
    3. Run: light installer.wixobj -o Intentioned-Setup.msi
    
    Or use the build script: build-msi.bat
-->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <Product Id="*" 
             Name="Intentioned" 
             Language="1033" 
             Version="1.0.0.0" 
             Manufacturer="Intentioned" 
             UpgradeCode="A1B2C3D4-E5F6-7890-ABCD-EF1234567890">
        
        <Package InstallerVersion="200" 
                 Compressed="yes" 
                 InstallScope="perUser" 
                 Description="Intentioned - Social Skills Training Platform"
                 Manufacturer="Intentioned"/>

        <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed."/>
        <MediaTemplate EmbedCab="yes"/>

        <!-- Installation Directory Structure -->
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="LocalAppDataFolder">
                <Directory Id="INSTALLFOLDER" Name="Intentioned">
                    <Directory Id="AppFolder" Name="intentioned.tech"/>
                </Directory>
            </Directory>
            <Directory Id="DesktopFolder" Name="Desktop"/>
            <Directory Id="ProgramMenuFolder">
                <Directory Id="ApplicationProgramsFolder" Name="Intentioned"/>
            </Directory>
        </Directory>

        <!-- Application Files Component -->
        <ComponentGroup Id="ProductComponents" Directory="AppFolder">
            <!-- Main application files with registry keys for per-user install -->
            <Component Id="ServerPy" Guid="B1C2D3E4-F5A6-4789-ABCD-EF1234567001">
                <File Id="server.py" Source="server.py"/>
                <RegistryValue Root="HKCU" Key="Software\Intentioned\Files" Name="server.py" Type="integer" Value="1" KeyPath="yes"/>
            </Component>
            <Component Id="ConfigToolPy" Guid="B1C2D3E4-F5A6-4789-ABCD-EF1234567002">
                <File Id="config_tool.py" Source="config_tool.py"/>
                <RegistryValue Root="HKCU" Key="Software\Intentioned\Files" Name="config_tool.py" Type="integer" Value="1" KeyPath="yes"/>
            </Component>
            <Component Id="ConfigJson" Guid="B1C2D3E4-F5A6-4789-ABCD-EF1234567003">
                <File Id="config.json" Source="config.json"/>
                <RegistryValue Root="HKCU" Key="Software\Intentioned\Files" Name="config.json" Type="integer" Value="1" KeyPath="yes"/>
            </Component>
            <Component Id="Requirements" Guid="B1C2D3E4-F5A6-4789-ABCD-EF1234567004">
                <File Id="requirements.txt" Source="requirements.txt"/>
                <RegistryValue Root="HKCU" Key="Software\Intentioned\Files" Name="requirements.txt" Type="integer" Value="1" KeyPath="yes"/>
            </Component>
            <Component Id="IndexHtml" Guid="B1C2D3E4-F5A6-4789-ABCD-EF1234567005">
                <File Id="index.html" Source="index.html"/>
                <RegistryValue Root="HKCU" Key="Software\Intentioned\Files" Name="index.html" Type="integer" Value="1" KeyPath="yes"/>
            </Component>
            <Component Id="ScriptJs" Guid="B1C2D3E4-F5A6-4789-ABCD-EF1234567006">
                <File Id="script.js" Source="script.js"/>
                <RegistryValue Root="HKCU" Key="Software\Intentioned\Files" Name="script.js" Type="integer" Value="1" KeyPath="yes"/>
            </Component>
            <Component Id="InstallScript" Guid="B1C2D3E4-F5A6-4789-ABCD-EF1234567007">
                <File Id="install.ps1" Source="install.ps1"/>
                <RegistryValue Root="HKCU" Key="Software\Intentioned\Files" Name="install.ps1" Type="integer" Value="1" KeyPath="yes"/>
            </Component>
            <!-- RemoveFile entries for clean uninstall -->
            <Component Id="CleanupFiles" Guid="B1C2D3E4-F5A6-4789-ABCD-EF1234567008">
                <RemoveFile Id="RemoveAppFolder" Name="*" On="uninstall" Directory="AppFolder"/>
                <RemoveFolder Id="RemoveAppFolderDir" Directory="AppFolder" On="uninstall"/>
                <RemoveFolder Id="RemoveInstallFolder" Directory="INSTALLFOLDER" On="uninstall"/>
                <RegistryValue Root="HKCU" Key="Software\Intentioned" Name="Cleanup" Type="integer" Value="1" KeyPath="yes"/>
            </Component>
        </ComponentGroup>

        <!-- Desktop Shortcuts -->
        <DirectoryRef Id="DesktopFolder">
            <Component Id="DesktopShortcut" Guid="*">
                <Shortcut Id="DesktopShortcutMain"
                          Name="Intentioned"
                          Description="Start Intentioned Server"
                          Target="[INSTALLFOLDER]StartIntentioned.bat"
                          WorkingDirectory="AppFolder"/>
                <Shortcut Id="DesktopShortcutConfig"
                          Name="Intentioned Config"
                          Description="Configure Intentioned"
                          Target="[SystemFolder]cmd.exe"
                          Arguments="/c &quot;cd /d [AppFolder] &amp;&amp; myenv\Scripts\python.exe config_tool.py&quot;"
                          WorkingDirectory="AppFolder"/>
                <RegistryValue Root="HKCU" Key="Software\Intentioned" Name="DesktopShortcut" Type="integer" Value="1" KeyPath="yes"/>
            </Component>
        </DirectoryRef>

        <!-- Start Menu Shortcuts -->
        <DirectoryRef Id="ApplicationProgramsFolder">
            <Component Id="StartMenuShortcuts" Guid="*">
                <Shortcut Id="StartMenuMain"
                          Name="Intentioned"
                          Description="Start Intentioned Server"
                          Target="[INSTALLFOLDER]StartIntentioned.bat"
                          WorkingDirectory="AppFolder"/>
                <Shortcut Id="StartMenuConfig"
                          Name="Intentioned Config"
                          Description="Configure Intentioned"
                          Target="[SystemFolder]cmd.exe"
                          Arguments="/c &quot;cd /d [AppFolder] &amp;&amp; myenv\Scripts\python.exe config_tool.py&quot;"
                          WorkingDirectory="AppFolder"/>
                <Shortcut Id="StartMenuUninstall"
                          Name="Uninstall Intentioned"
                          Target="[SystemFolder]msiexec.exe"
                          Arguments="/x [ProductCode]"/>
                <RemoveFolder Id="CleanupStartMenu" Directory="ApplicationProgramsFolder" On="uninstall"/>
                <RegistryValue Root="HKCU" Key="Software\Intentioned" Name="StartMenuShortcuts" Type="integer" Value="1" KeyPath="yes"/>
            </Component>
        </DirectoryRef>

        <!-- Feature Definition -->
        <Feature Id="MainApplication" Title="Intentioned" Level="1" ConfigurableDirectory="INSTALLFOLDER">
            <ComponentGroupRef Id="ProductComponents"/>
            <ComponentRef Id="DesktopShortcut"/>
            <ComponentRef Id="StartMenuShortcuts"/>
        </Feature>

        <!-- Custom UI Sequence -->
        <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER"/>
        
        <!-- License Agreement (optional - create LICENSE.rtf) -->
        <WixVariable Id="WixUILicenseRtf" Value="LICENSE.rtf"/>
        
        <!-- Custom Action: Run install.ps1 after install -->
        <CustomAction Id="RunInstallScript"
                      Directory="INSTALLFOLDER"
                      ExeCommand="powershell.exe -ExecutionPolicy Bypass -File &quot;[AppFolder]install.ps1&quot; -NoConfigTool"
                      Execute="deferred"
                      Impersonate="yes"
                      Return="asyncNoWait"/>

        <!-- Custom Action: Open Config Tool (optional) -->
        <Property Id="LAUNCHCONFIG" Value="1"/>
        <CustomAction Id="LaunchConfigTool"
                      Directory="AppFolder"
                      ExeCommand="[SystemFolder]cmd.exe /c &quot;myenv\Scripts\python.exe config_tool.py&quot;"
                      Execute="immediate"
                      Return="asyncNoWait"/>

        <InstallExecuteSequence>
            <Custom Action="RunInstallScript" Before="InstallFinalize">NOT Installed</Custom>
        </InstallExecuteSequence>

        <!-- UI Reference -->
        <UIRef Id="WixUI_InstallDir"/>
        <UIRef Id="WixUI_ErrorProgressText"/>

        <!-- Option to launch config after install -->
        <UI>
            <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchConfigTool">LAUNCHCONFIG = 1</Publish>
        </UI>
    </Product>
</Wix>
