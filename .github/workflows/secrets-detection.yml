name: Secrets & Certificate Detection

on:
  pull_request:
  push:
    branches:
      - main
      - master

permissions:
  contents: read

jobs:
  secrets-detection:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for private keys
        run: |
          echo "üîç Checking for private keys..."
          
          # Search for common private key patterns
          if grep -r -E "BEGIN (RSA|DSA|EC|OPENSSH|ENCRYPTED|PRIVATE) PRIVATE KEY" . --exclude-dir=.git --exclude-dir=node_modules; then
            echo "‚ùå ERROR: Private key detected in repository!"
            exit 1
          fi
          
          # Check for .key files
          if find . -type f -name "*.key" ! -path "./.git/*" ! -path "./node_modules/*"; then
            echo "‚ùå ERROR: .key files detected in repository!"
            exit 1
          fi
          
          # Check for .pem files that might be private keys
          if find . -type f -name "*.pem" ! -path "./.git/*" ! -path "./node_modules/*"; then
            echo "‚ùå ERROR: .pem files detected in repository!"
            exit 1
          fi
          
          echo "‚úÖ No private keys detected"
      
      - name: Check for certificate files
        run: |
          echo "üîç Checking for certificate files..."
          
          # Check for certificate files
          cert_files=$(find . -type f \( -name "*.crt" -o -name "*.cer" -o -name "*.p12" -o -name "*.pfx" \) ! -path "./.git/*" ! -path "./node_modules/*" || true)
          
          if [ -n "$cert_files" ]; then
            echo "‚ùå ERROR: Certificate files detected in repository!"
            echo "$cert_files"
            exit 1
          fi
          
          echo "‚úÖ No certificate files detected"
      
      - name: Check for common secret patterns
        run: |
          echo "üîç Checking for common secret patterns..."
          
          # Check for AWS keys
          if grep -r -E "AKIA[0-9A-Z]{16}" . --exclude-dir=.git --exclude-dir=node_modules 2>/dev/null; then
            echo "‚ö†Ô∏è  WARNING: Possible AWS access key detected"
          fi
          
          # Check for common password/secret patterns in code
          if grep -r -i -E "(password|passwd|pwd|secret|api_key|apikey|token)[\s]*=[\s]*['\"][^'\"]{8,}" . --include="*.py" --include="*.js" --include="*.sh" --exclude-dir=.git --exclude-dir=node_modules 2>/dev/null | grep -v "YOUR_" | grep -v "REPLACE" | grep -v "EXAMPLE" | grep -v "TODO"; then
            echo "‚ö†Ô∏è  WARNING: Possible hardcoded credentials detected (review manually)"
          fi
          
          echo "‚úÖ Secret pattern check completed"
      
      - name: Check .gitignore for security patterns
        run: |
          echo "üîç Verifying .gitignore includes security patterns..."
          
          required_patterns=("*.pem" "*.key" "cert.pem" "key.pem")
          missing_patterns=()
          
          for pattern in "${required_patterns[@]}"; do
            if ! grep -q "$pattern" .gitignore; then
              missing_patterns+=("$pattern")
            fi
          done
          
          if [ ${#missing_patterns[@]} -gt 0 ]; then
            echo "‚ö†Ô∏è  WARNING: .gitignore missing security patterns:"
            printf '%s\n' "${missing_patterns[@]}"
          else
            echo "‚úÖ .gitignore includes all required security patterns"
          fi
